var restaurant_menu = {
	"Info":{
		"name":"Banaleaf",
		"location":"Milpitas",
		"phone":"4084317445",
		"logo" : "http://www.bananaleaf-usa.com/assets/images/BLogo.gif",
		"bkcolor" : "#FCC",
		"Tax" : "8%",
		"id" : "4084317445"
		},
	"Menu":{
		"Small Plates & Appertizers":{
			"Gado-Gado":{ "price":"$7.95", "description":"assorted vegetables, fried prawn's cake & tofu with peanut sauce"},
			"Chicken $7.95,Beef or Combo Satay ":{ "price":"$8.95", "description":"with cucumber & onion dipped in peanut sauce "},
			"Green Papaya Salad ":{ "price":"$7.95", "description":"with shrimps, vegetables, almond & kesom leaves"},
			"Lobak ":{ "price":"$8.95", "description":"chicken egg roll, fried tofu, fried prawn cake with Hoisin sauce & chili "},
			"Yu Sang ":{ "price":"$14.95", "description":"tuna sashimi with mango, papaya, leeks, taro, ginger, sesame, peanut & etc"},
			"Fresh Spring Rolls ":{ "price":"$6.95", "description":"with shrimp, vermicelli, bean sprouts, basil & Chef's peanut sauce"},
			"Sambal Anchovy ":{ "price":"$5.95", "description":"with onion & cucumber "},
			"Roti Prata":{ "price":"$2.95", "description":"multi-layered home made Indian bread dipped in curry sauce"},
			"Roti Telur ":{ "price":"$4.95", "description":"multi-layered home made Indian bread with egg dipped in curry sauce"},
			"Roti Murtabak":{ "price":"$7.95", "description":"multi-layered home made Indian bread with beef, egg & onion dipped in curry sauce"},
			"Tofu Salad ":{ "price":"$7.95", "description":"fried tofu triangles full of crunchy vegetables with peanut sauce"},
			"Penang Poh Piah ":{ "price":"$6.95", "description":"steamed spring rolls stuffed with dried shrimps & vegetables"}
		},
			
		"Soup":{
			"Tom Yaml Soup":{ "price":{"Small":"$8.50","Large":"$11.50"}, "description":"hot & sour soup with seafood, mushrooms, lime juice & lemon grass"},
			"Galangal & Kaffir Lime Soup":{ "price":{"Small":"$8.50","Large":"$11.50"}, "description":"with seafood or chicken in coconut milk"}
		},
		"Poultry":{
			"Mango Chicken ":{ "price":"$12.95", "description":"with green & red peppers in a spicy mango sauce served in a mango shell"},
			"Istimewa Chicken ":{ "price":"$10.50", "description":"with chef's fresh seasoning & dried shrimp paste sauce"},
			"Kapitan Chicken ":{ "price":"$9.95", "description":"in fresh curry leaf & lemon gress flavor with eggplant, tomato & potato"},
			"Utama Basil Chicken ":{ "price":"$9.95", "description":"with snap peas & red onion in Chief's basil sauce"},
			"Singaporean Black Pepper Chicken":{ "tag":"New!","price":"$10.95", "description":"with eggplant & string beans"},
			"Rendang Chicken ":{ "price":"$9.95", "description":"with chef's special Malay curry sauce"},
			"Green or Red Curry Chicken ":{ "price":"$9.95", "description":"with freshly selected vegetables "},
			"Tai Pou Chicken":{ "price":"$8.50", "description":"chef's special deep fried chicken with Tai Pou spicy sauce"},
			"Malay Sizzling Chicken":{ "price":"$9.95", "description":"with black pepper sauce, anaheim chili, red bell pepper & sweet onion"},
			"Penang Sizzling Chicken":{ "price":"$10.95", "description":"with onion, green & red bell pepper with chef's special shrimp paste sauce"}
		},
		"Beef & Lamb (Grass Fed Beef & Lamb)":{
			"Rendang Beef ":{ "price":"$11.50", "description":"with chef's special Malay curry sauce"},
			"Green or Red Curry Beef ":{ "price":"$11.95", "description":"with freshly selected vegetables"},
			"Utama Basil Beef":{ "price":{ "Beef":"$11.95","Lamb": "$14.95"}, "description":"with chef's special ginger flower sauce  "},
			"Istimewa Beef ":{ "price":"$11.95", "description":"with chef's fresh seasoning & dried shrimp paste sauce "},
			"Malay Sizzling Beef":{ "price":{"Beef":"$13.95","Lamb":"$14.95"}, "description":"with black pepper sauce, anaheim chili, red bell pepper & sweet onion"},
			"Penang Curry Lamb or Green Curry Lamb ":{ "price":"$14.95", "description":"simmered in Penang curry sauce with freshly selected vegetables"},
			"Cumin Lamb ":{ "price":"$14.95", "description":"with lemongrass, Thai chili & cilantro"},
			"Singaporean Black Pepper Beef":{ "tag":"New!","price":{"Beef":"$12.95","Lamb":"$14.95"}, "description":"with eggplant & string beans"}
		},
		"Seafood":{
			"Mango Prawns":{ "price":"$13.95", "description":"with green & red peppers in a spicy mango sauce served in a mango shell "},
			"Penang Sizzling Prawns":{ "price":{"Prawns":"$2.95","Jumbo Scallops":"$19.95"}, "description":"with onion, green & red pepper with chef's special sauce"},
			"Malay Sizzling Black Pepper Prawns":{ "price":"$12.95"},
			"Malay Sizzling Black Pepper Jumbo Scallops":{ "price":"$19.95"},
			"Oatmeal Battered Jumbo Prawns":{ "price":"$20.95"},
			"Asam Prawns":{ "price":{"Prawns":"$12.95","Jumbo Prawns":"$19.95"}, "description":"with hot and sour tamarind sauce  "},
			"Siam Prawns":{ "price":{"Prawns":"$12.95","Jumbo Prawns":"$19.95"}, "description":"with chef's special ginger flower sauce  "},
			"Singaporean Chili Prawns":{ "price":{"Prawns":"$12.95","Jumbo Prawns":"$19.95"}, "description":"with chef's chili garlic tomato sauce and egg  "},
			"Utama Basil Prawns ":{ "price":"$12.95", "description":"with snap peas & red onion in Chef's basil sauce"},
			"Rempah Squid ":{ "price":"$9.95", "description":"with dried chili sauce"},
			"Rempah Prawns":{ "price":"$12.95", "description":"with dried chili sauce"},
			"Melaka Prawns ":{ "price":"$12.95", "description":"with chef's lemon grass sauce"},
			"Singaporean Black Pepper Prawns":{ "tag":"New!","price":{"Prawns":"$12.95","Jumbo Prawns":"$19.95"}, "description":"with eggplant & string beans"},
			"Red Curry Prawns ":{ "price":"$12.95", "description":"with freshly selected vegetables"},
			"Indian Red Curry Fish Head":{ "price":"$13.95", "description":"with freshly selected vegetables in clay pot"},
			"Asam Fish Head":{ "price":"$13.95", "description":"with hot & sour tamarind sauce"},
			"Indian Red Curry Salmon    $15.95":{ "price":{"Salmon":"$15.95","Seabass":"$27.95"}, "description":"with freshly selected vegetables in clay pot"},
			"Banana Leaf wrapped Grilled Seabass ":{ "price":"$27.95", "description":"with finely chopped herbs, spices, & sambal chilli"},
			"Melaka White Pomfret":{ "price":{"Ponfret":"$15.95","Salmon":"$15.95","Seabass":"$27.95"}, "description":"with chef's lemon grass sauce  "},
			"Siam White Pomfret":{ "price":{"Ponfret":"$15.95","Salmon":"$15.95","Seabass":"$27.95"}, "description":"with chef's special ginger flower sauce & fresh mango  "},
			"Asam White Pomfret":{ "price":{"Ponfret":"$15.95","Salmon":"$15.95","Seabass":"$27.95"}, "Description":"with hot and sour tamarind sauce "},
			"Sarang Seafood ":{ "price":"$16.95", "description":"assorted seafood with vegetables, mushrooms & cashew nuts in a formed fried taro nest"},
			"Dungeness Crab..... ":{ "price":{"each":"$30.95"}},
			"Singaporean Chili Crab ":{ "price":{"each":"$30.95"}, "description":"with chef's chili garlic tomato sauce and egg"},
			"Singaporean Black Pepper Crab ":{ "price":{"each":"$30.95"}, "description":"with chef's spicy black pepper sauce"},
			"Sambal Malaysian Crab ":{ "price":{"each":"$30.95"}, "description":"with chef's fresh seasoning dried spicy sauce"}
		},
		"Vegetables":{
			"Belachan Eggplant or String Beans":{ "price":"$8.95", "description":"with Malay special shrimp paste sauce "},
			"Belachan KangKung (Ong Choy),Okra or Asparagus":{ "price":"$9.95", "description":"with Malay special shrimp paste sauce"},
			"Utama Basil Snap Peas":{ "price":"$9.95", "description":"with shiitake mushroom, tofu & red onion in Chef's basil sauce"},
			"Melaka Eggplant or String Beans ":{ "price":"$8.50", "description":"with chef's lemon grass sauce"},
			"Melaka Asparagus or Okra ":{ "price":"$8.95", "description":"with chef's lemon grass sauce "},
			"Asam Eggplant or String Beans ":{ "price":"$8.50", "description":"with hot and sour tamarind sauce "},
			"Asam Asparagus or Okra ":{ "price":"$8.95", "description":"with hot and sour tamarind sauce "},
			"Sauteed Eggplant or String Beans ":{ "price":"$7.95", "description":"with garlic "},
			"Sauteed Asparagus or KangKung (Ong Choy) ":{ "price":"$9.50", "description":"with garlic "},
			"Red or Green Curry Vegetables with Tofu":{ "price":{"Tofu":"$8.95","Kangkung & Calamari ":"$10.95"}, "description":"with chef's special sesame and peanut sauce  "},
			"Cumin Tofu":{ "price":"$8.95", "description":"with string beans, lemongrass, Thai chili & cilantro"},
			"Singaporean Black Pepper Eggplant & String Beans":{ "price":"$8.95"}
		},
		"Noodles":{
			"Penang Asam Laksa":{ "price":"$8.95", "description":"hot & sour lai-fun noodles in lemon grass fish broth with fish, onion & pineapple"},
			"Chicken Curry Laksa Mee":{ "price":"$8.95", "description":"red curry noodles soup with Chef's lemon grass and curry broth with chicken & vegetables"},
			"Seafood Curry Laksa Mee":{ "price":"$9.50", "description":"red curry noodles soup with Chef's lemon grass and curry broth with seafood & vegetables"},
			"Prawn Mee Soup":{ "price":"$8.95", "description":"shrimp noodles soup with chef's special shrimp borth, chicken, egg, kang kung & bean sprouts"},
			"Pahd Thai":{ "price":"$9.50", "description":"pan-fried rice noodles with prawns, squids, chicken, eggs, tofu, grounded peanuts & bean sprouts"},
			"Chow Kueh Teow ":{ "price":"$9.50", "description":"Hokkeinese stir-fried rice noodles with prawns, squids, eggs & bean sprouts"},
			"Ying Yong Noodles ":{ "price":"$9.50", "description":"flat rice noodles, vermicelli with prawns, squids, chicken & vegetables in thick egg sauce"},
			"Indian Mee Goreng ":{ "price":"$9.50", "description":"Indian spicy fried noodles with prawns, squids, chicken, tofu, eggs, grounded peanuts & bean sprouts"},
			"Huat Dan Ho or Huat Dan Bee Hoon":{ "price":"$9.50", "description":"flat rice noodles or vermicelli with prawns, squids, chicken, eggs & vegetables in thick egg sauce"},
			"e Noodles ":{ "price":"$9.50", "description":"with prawns, squids, chicken & vegetables with thick egg sauce in clay pot or crispy-fried  "},
			"Hokkein Char Mee":{ "tag":"New!","price":"$9.50", "description":"thick wheat noodles served in traditional caramel soy sauce with prawns"}
		},
		"Rice":{
			"Banana Leaf Rice":{ "price":"$7.95", "add":{"Rendang Beef":"$1"}, "description":"Malay special coconut rice served with rendang chicken, broiled egg, sambal anchovy, onion, cucumber & peanuts on a banana leaf"},
			"Hainan Chicken with Rice ":{ "price":"$8.95", "description":"steam chicken served with chef's special soy sauce & Hainan seasoned rice (chicken is served cold with bones & skin, boneless is available upon request)"},
			"Pineapple Fried Rice ":{ "price":"$9.95", "description":"with pineapple bits, cashews, shrimps, chicken & peas stuffed in a pineapple"},
			"Indian Nasi Goreng ":{ "price":"$9.50", "description":"Indian spicy fried rice with prawns, squids, chicken, tofu & eggs "},
			"Basil Fried Rice":{ "price":"$9.50", "description":"with prawns, squids, chicken, tofu, cilantro & Thai chili"},
			"Malay Coconut Milk Rice ":{ "price":"$2.00"},
			"Hainan Seasoned Rice  with turmeric":{ "price":"$2.00"},
			"Brown Rice ":{ "price":"$2.00"},
			"Steam Rice":{ "price":"$1.50"}
		},
		"Side Products":{
			"Curry Sauce":{ "price":{"Small":"$2","Large":"$6"}},
			"Satay Sauce":{ "price":{"Small":"$4","Large":"$10"}},
			"Sambal Belachan":{ "price":{"Small":"$5","Large":"$15"}},
			"Chef's Hat (adjustable size)":{ "price":"$25.00"}
		}
	},
	"Cart" : {
		"NoItems" : 0,
		"Total" : 0,
		"GrandTotal" : 0,
		"Gratuity" : 0
	}
	
};

var global = {
	Msg_Wall_Url : 'http://www.parthamukherjee.com/cgi-perl/SimpleMessageBoard.cgi',
	Msg_Wall_SHOW_Url : 'http://www.parthamukherjee.com/cgi-perl/SimpleMessageBoard.cgi/ADD/',
	Msg_Wall_ADD_Url : 'http://www.parthamukherjee.com/cgi-perl/SimpleMessageBoard.cgi/SHOW/',
	MaxPreviousOrderStore:5,
	Message:"",
	Error:"",
	Input:""
};

/*
Page Template
function Page_Order(urlObj, options) {
	var $page = $('#pagename');
	// Get the header for the page.
	$header = $page.children( ":jqmData(role=header)" );
	$content = $page.children( ":jqmData(role=content)" );
	$footer = $page.children( ":jqmData(role=footer)" );
	$header.find( "h1" ).html("Order");
	
	var markup = "Under construction";
	
	$content.html( markup );	
	$page.page();
	$content.find( ":jqmData(role=listview)" ).listview();
	options.dataUrl = urlObj.href;
	$.mobile.changePage( $page, options );
}
*/

function loadPostInput() {
	// Always flush the Input to make sure old values does not linger
	global.Input = Array();
	if ( typeof options.data != 'undefined' ) { // If input is provided then read it
		var data = options.data.split('&');	
		for (var i = 0 ; i < data.length ; ++i ) {
			var pair = data[i].split('=');
			global.Input[pair[0]] = pair[1];
		}
	}
}
function parseUrlforOrders(urlObj) {
	var sUrl = urlObj.href.split('?');
	//alert("Surl = "+sUrl);
	var qUrl = sUrl[1].split('&');
	//alert("Qurl = "+qUrl);
	var qstr = [];;
	for (var i = 0 ; i < qUrl.length ; ++i) {
		//alert(i+" : "+qUrl[i]);
		pUrl = qUrl[i].split('=');
		if ( pUrl.length > 0 ) {
			//alert("Split 1 = "+pUrl[0]+" split 2 = "+pUrl[1]);
			qstr[pUrl[0]] = pUrl[1];
		}
		//qstr[pUrl[0]] = pUrl[1];
	}
	return [qstr['category'],qstr['item'],qstr['parts'],qstr['price']];	
}

//Add orders in the restaurant_menu object and then build the Item Block
function ops_addItem(urlObj, options) {
	var qstr = parseUrlforOrders(urlObj);
	var category = qstr[0];
	var item = qstr[1];
	var parts = qstr[2];
	var price = qstr[3];
	category = category.replace(/\%26/g,'&');
	item = item.replace(/\%26/g,'&');
	//alert("Add Item in Category = "+category);
	if ( typeof restaurant_menu.Menu[category] == 'undefined' )
		return;
	//alert(item);
	if ( typeof parts != 'undefined' ) {
		//alert(category);
		//alert(item);
		if (typeof  restaurant_menu.Menu[category][item].order != 'undefined') {
			if (typeof restaurant_menu.Menu[category][item].order[parts] != 'undefined' ) {
				restaurant_menu.Menu[category][item].order[parts] += 1;
			}
			else {
				restaurant_menu.Menu[category][item].order.push(parts);
				restaurant_menu.Menu[category][item].order[parts] = 1;
			}
		}
		else {
			restaurant_menu.Menu[category][item].order = [parts];
			restaurant_menu.Menu[category][item].order[parts] = 1;
		}
	}
	else {
		if ( typeof restaurant_menu.Menu[category][item].order != 'undefined' ) {
			restaurant_menu.Menu[category][item].order += 1;
		}
		else {
			restaurant_menu.Menu[category][item].order = 1;
		}
	}
	restaurant_menu.Cart.Total += parseFloat(price.replace('$',''));
	restaurant_menu.Cart.NoItems += 1;
	//alert("Changing page to "+$.mobile.path.makeUrlAbsolute('#menuitems?item='+category.replace('&','%26'),urlObj));
	$.mobile.changePage($.mobile.path.makeUrlAbsolute('#menuitems?item='+category.replace(/&/g,'%26'),urlObj));
}

function ops_removeItem(urlObj, options) {
	var qstr = parseUrlforOrders(urlObj);
	var category = qstr[0];
	var item = qstr[1];
	var parts = qstr[2];
	var price = qstr[3];
	category = category.replace(/\%26/g,'&');
	item = item.replace(/\%26/g,'&');
	//alert(category);
	//alert(item);
	if ( typeof parts != 'undefined' ) {
		if ( typeof restaurant_menu.Menu[category][item].order != 'undefined' ) {
			if ( restaurant_menu.Menu[category][item].order[parts] > 0) {
				restaurant_menu.Menu[category][item].order[parts] -= 1;
				restaurant_menu.Cart.Total -= parseFloat(price.replace('$',''));
				restaurant_menu.Cart.NoItems -= 1;
			}
			if ( restaurant_menu.Menu[category][item].order[parts] == 0 ) {
				delete restaurant_menu.Menu[category][item].order[parts]; 
				if ( restaurant_menu.Menu[category][item].order.length < 1 )
					delete restaurant_menu.Menu[category][item].order;
			}
		}
	}
	else {
		if ( restaurant_menu.Menu[category][item].order > 0) {
			restaurant_menu.Menu[category][item].order -= 1;
			restaurant_menu.Cart.Total -= parseFloat(price.replace('$',''));
			restaurant_menu.Cart.NoItems -= 1;
		}
		if (restaurant_menu.Menu[category][item].order == 0)
			delete restaurant_menu.Menu[category][item].order;
	}
	$.mobile.changePage($.mobile.path.makeUrlAbsolute('#menuitems?item='+category.replace(/&/g,'%26'),urlObj));
}

function buildItemBlock(categoryName,category) {
	//var markup = "<ul data-role='listview' data-inset='true' data-theme='d'>";
	var markup = '<table>';
	// The array of items for this category.
	//alert("Called with "+categoryName);
	var cName_escaped = categoryName.replace(/&/g,'%26');
	Object.keys(category).forEach(function(key) {
		var key_escaped = key.replace(/&/g,'%26');
		//alert("Escaped Key = "+key_escaped);
		var elements = category[key];
		var priceObj = elements["price"];
		if ( typeof elements["price"] === "string" ) {	//Case of simple pricing		
				//alert(key+" is ordered by "+elements.order);
				markup += '<tr><td>';
				markup += '<a href="#ops_removeItem?category='+cName_escaped+'&item='+key_escaped+'&price='+priceObj+'"><img src="images/minus.png" alt="minus"/></a>';
				markup += '</td>';
				markup += '<td>';
				if ( typeof elements.order != 'undefined' ) {
					markup += '<label>'+key +'<br /> '+elements.order+' x '+priceObj+'</label>';
				}
				else {
					markup += '<label>'+key +'<br />'+priceObj+'</label>';
				}
				markup += '</td>';
				
				markup += '<td>';
				markup += '<a href="#ops_addItem?category='+cName_escaped+'&item='+key_escaped+'&price='+priceObj+'"><img src="images/plus.png" alt="plus"/></a>';
				markup += '</td></tr>';
		}
		else { // Case of complex pricing
			Object.keys(priceObj).forEach(function(parts) {
				var price = priceObj[parts];
				markup += '<tr><td>';
				markup += '<a href="#ops_removeItem?category='+cName_escaped+'&item='+key_escaped+'&parts='+parts+'&price='+price+'"><img src="images/minus.png" alt="minus"/></a>';
				markup += '</td>';
				markup += '<td>';
				if ( ( typeof elements.order != 'undefined' ) 
					&& ( typeof elements.order[parts] != 'undefined' ) ){
					//alert(parts + " Creating for "+elements.order[parts]);
					markup += '<label>'+key +'<br />['+parts+'] '+elements.order[parts]+' x '+price+'</label>';
				}
				else {
					markup += '<label>'+key+'<br />['+parts+'] '+price+'</label>';
				}
				markup += '</td>';
				
				markup += '<td>';
				markup += '<a href="#ops_addItem?category='+cName_escaped+'&item='+key_escaped+'&parts='+parts+'&price='+price+'"><img src="images/plus.png" alt="plus"/></a>';
				markup += '</td></tr>';
			});
		}
	});
	markup += '</table>';
	if (restaurant_menu.Cart.Total > 0) {
		markup += '<br /><div id="cartinfo"><a href="#cart" data-role="button" data-rel="dialog" data-rel="back">Order</a></div>';
	}
	
	return markup;
}

// Load the data for a specific category, based on
// the URL passed in. Generate markup for the items in the
// category, inject it into an embedded page, and then make
// that page the current active page.
function Page_MenuItems( urlObj, options )
{
	var categoryName = urlObj.hash.replace( /.*item=/, "" );

	// Get the object that represents the category we
	// are interested in. Note, that at this point we could
	// instead fire off an ajax request to fetch the data, but
	// for the purposes of this sample, it's already in memory.
	categoryName = categoryName.replace(/\%26/g,'&');
	//alert("Show Category "+categoryName);
	category = restaurant_menu.Menu[categoryName];
	// The pages we use to display our content are already in
	// the DOM. The id of the page we are going to write our
	// content into is specified in the hash before the '?'.
	pageSelector = urlObj.hash.replace( /\?.*$/, "" );
	//alert("Show Category *"+categoryName+"* Page Selector"+pageSelector);
	if ( category ) {
		// Get the page we are going to dump our content into.
		var $page = $(pageSelector);

		// Get the header for the page.
		$header = $page.children( ":jqmData(role=header)" );

		// Get the content area element for the page.
		$content = $page.children( ":jqmData(role=content)" );
		
		$footer = $page.children( ":jqmData(role=footer)" );
		
		// The markup we are going to inject into the content
		// area of the page.
		markup = buildItemBlock(categoryName,category);
		
		// Find the h1 element in our header and inject the name of
		// the category into it.
		$header.find( "h1" ).html( categoryName );

		// Inject the category items markup into the content element.
		$content.html( markup );

		if ( restaurant_menu.Cart.Total > 0 ) {
			$footer.find("h4").html("Total = $"+Math.round(restaurant_menu.Cart.Total*100)/100);
		}
			
		// Pages are lazily enhanced. We call page() on the page
		// element to make sure it is always enhanced before we
		// attempt to enhance the listview markup we just injected.
		// Subsequent calls to page() are ignored since a page/widget
		// can only be enhanced once.
		$page.page();

		// Enhance the listview we just injected.
		//$content.find( ":jqmData(role=listview)" ).listview();

		// We don't want the data-url of the page we just modified
		// to be the url that shows up in the browser's location field,
		// so set the dataUrl option to the URL for the category
		// we just loaded.
		options.dataUrl = urlObj.href;

		// Now call changePage() and tell it to switch to
		// the page we just modified.
		//alert("Show Category Change Page to "+pageSelector);
		$.mobile.changePage( $page, options );
	}
	else {
		alert("No Category");
	}
}

function get_OrderTable() {
	var markup = '<table>';
	Object.keys(restaurant_menu.Menu).forEach(function(category) {
		var added_category_header = 0;
		Object.keys(restaurant_menu.Menu[category]).forEach(function(item) {
			if ( typeof restaurant_menu.Menu[category][item].order != 'undefined' ) { // Has Order so need to record
				if ( added_category_header == 0 ) { // Make Category Header
					markup += '<tr><th>'+category+'</th></tr>';
					added_category_header = 1;
				}
				if ( typeof restaurant_menu.Menu[category][item]["price"] === "string" ) { // Single Price structure -- Add item quantity price
					markup += '<tr><td>'+item+'</td><td>'+restaurant_menu.Menu[category][item].order+' x </td><td>'+restaurant_menu.Menu[category][item].price+'</td></tr>';
				}
				else { // Variable Price structure -- Add item [type] quantity price
					Object.keys(restaurant_menu.Menu[category][item].price).forEach(function(parts) {
						if ( typeof restaurant_menu.Menu[category][item].order[parts] != 'undefined') {
							//alert(restaurant_menu.Menu[category][item].order[parts]);
							markup += '<tr><td>'+item+' </td><td>[ '+restaurant_menu.Menu[category][item].order[parts]+' x '+parts+' ]</td><td>'+restaurant_menu.Menu[category][item].price[parts]+'</td></tr>';
						}
					});
				}
			}
		});
	});
	var tax = parseFloat(restaurant_menu.Info.Tax.replace('%',''));
	var tax_amount = Math.round(restaurant_menu.Cart.Total*tax)/100;
	restaurant_menu.Cart.GrandTotal = Math.round((restaurant_menu.Cart.Total+tax_amount)*100)/100;
	markup += '<tr><td colspan=3></td></tr>';
	markup += '<tr><td colspan=3>----------------------------------</td></tr>';
	markup += '<tr><td>Total</td><td></td><td>'+(Math.round(restaurant_menu.Cart.Total*100)/100)+'</td></tr>';
	markup += '<tr><td colspan=3>----------------------------------</td></tr>';
	markup += '<tr><td>Tax ('+restaurant_menu.Info.Tax+')</td><td></td><td>'+tax_amount+'</td></tr>';
	markup += '<tr><td colspan=3>----------------------------------</td></tr>';
	markup += '<tr><td>Total after taxes</td><td></td><td>'+restaurant_menu.Cart.GrandTotal+'</td></tr>';
	markup += '</table>';
	return markup;
}

function Page_Cart(urlObj, options) {
	//alert("Building Cart");
	// Get the page we are going to dump our content into.
	var $page = $('#cart');
	// Get the header for the page.
	$header = $page.children( ":jqmData(role=header)" );
	$content = $page.children( ":jqmData(role=content)" );
	$footer = $page.children( ":jqmData(role=footer)" );
	$header.find( "h1" ).html("Cart");
	
	var markup = get_OrderTable();
	
	// Store the Order for future access
	var ono = 0;
	if ( typeof localStorage.getItem("OrderNo") != 'undefined' ) {
		ono = localStorage.getItem("OrderNo");
	}
	if ( ono > global.MaxPreviousOrderStore ) {
		ono = 0
	}
	ono += 1;
	localStorage.setItem("OrderNo",ono);
	localStorage.setItem("OrderNo_"+ono,markup);
	
	// Add the big order button
	if ( localStorage.getItem('Name') && localStorage.getItem('Phone') ) { // Have the order inputs so go to orders directly
		markup += '<br /><a href="#sendneworder" data-role="button">Order</a>';
	}
	else {
		markup += '<br /><a href="#collectinfo" data-role="button" data-rel="dialog" data-transition="pop" data-rel="back">Order</a>';
	}
	// Inject the category items markup into the content element.
	$content.html( markup );	
	$page.page();
	options.dataUrl = urlObj.href;
	$.mobile.changePage( $page, options );
}

function Page_CollectInfo(urlObj, options) {
	var $page = $('#collectinfo');
	// Get the header for the page.
	$header = $page.children( ":jqmData(role=header)" );
	$content = $page.children( ":jqmData(role=content)" );
	$footer = $page.children( ":jqmData(role=footer)" );
	$header.find( "h1" ).html("Tell about yourself");
	
	var markup = '<form action="#sendneworder" method="POST">'; 
	markup += '<table>';
	markup += '<tr><td>Name:</td><td><input type="text" name="Name"><td></tr>';
	markup += '<tr><td>Phone:</td><td><input type="text" name="Phone"><td></tr>';
	markup += '<tr><td><input type="checkbox" name="remember_me"></td><td>Remember Me<td></tr>';
	markup += '<tr><td></td><td><input type="submit" name="submit" value="Submit"></td></tr>';
	markup += '</table>';
	markup += '</form>';
	
	$content.html( markup );	
	$page.page();
	options.dataUrl = urlObj.href;
	$.mobile.changePage( $page, options );
}

/*
New Order transmits the order created by the user along with name and phone number
*/
function ops_sendNewOrder(urlObj, options) {
	loadPostInput();
	if (global.Input['remember_me'] == 'on') { // Store the inputs locally
		localStorage.setItem('Name',global.Input['Name']);
		localStorage.setItem('Phone',global.Input['Phone']);
	}
	
	// Get the values in local storage
	if ( !global.Input['Name'] )
		global.Input['Name'] = localStorage.getItem('Name');
	if ( !global.Input['Phone'] )
		global.Input['Phone'] = localStorage.getItem('Phone');
	
	// Order with Name and Phone number ready	
	var order_details = get_OrderTable();
	order_details += '<br /><strong>Name = '+global.Input['Name']+'<br /> Phone = '+global.Input['Phone']+'</strong>';
	
	// Send the order
	ops_postMessage(order_details);
}

function ops_PostFormMessage(urlObj, options) {
	loadPostInput();
	if (global.Input['msg']) { // Proceed to post the message
		ops_postMessage(global.Input['msg']);
	}
	else { // Go Back with this error
		global.Error = "<p>No msg in Form</p>";
		history.back(-1);
	}
}

function ops_postMessage(message) {
	var $page = $('#order');
	
	// Transmit the order
	var add_order_url = global.Msg_Wall_ADD_Url+input['Phone']+'/'+restaurant_menu.Info.id+'/?DIS_REVERSE=1&nohtml=1&msg='+message;
	
	// Send the order
	$.ajax({
		type: 'GET',
		url: add_order_url,
		dataType: 'json',
		cache:false,
		success: function(ret){
			// Add nessage to the display message box
			global.Message += ret.message;
			$page.page();
			options.dataUrl = urlObj.hrefNoHash;
			options.dataUrl += '#order';
			$.mobile.changePage( $page, options );
		},
		error: function(ret){
			global.Error = ret.message;
			history.back(-1);
		}
	});
}

function ops_getMessage() {
	var $page = $('#order');
	
	// Transmit the order
	var add_order_url = global.Msg_Wall_SHOW_Url+input['Phone']+'/'+restaurant_menu.Info.id+'/?DIS_REVERSE=1&nohtml=1';
	
	// Send the order
	$.ajax({
		type: 'GET',
		url: add_order_url,
		dataType: 'json',
		cache:false,
		success: function(ret){
			// Add nessage to the display message box
			global.Message += ret.message;
			$page.page();
			options.dataUrl = urlObj.hrefNoHash;
			options.dataUrl += '#order';
			$.mobile.changePage( $page, options );
		},
		error: function(ret){
			global.Error = ret.message;
			history.back(-1);
		}
	});
}

// Display Error, Message and a Box to capture new messages
// We need to add trigger to ping the server for updates at regular intervals
function Page_Order(urlObj, options) {
	var $page = $('#order');
	// Get the header for the page.
	$header = $page.children( ":jqmData(role=header)" );
	$content = $page.children( ":jqmData(role=content)" );
	$footer = $page.children( ":jqmData(role=footer)" );
	$header.find( "h1" ).html("Order");
	
	var errorBox = '<div class="error">'+global.Error+'</div>';
	var previousMsg = '<div id="prevMsg">'+global.Message+'</div>';
	var messageBox = '<form action="#postformmessage" method="POST">'; 
	messageBox += '<br /><label for="basic">Message:</label><input type="text" name="msg" id="msg" value="" data-mini="true" />';
	messageBox += '<br /><input type="submit" name="Send" value="msg">';
	var markup = errorBox+previousMsg + messageBox;
	
	$content.html( markup );	
	$page.page();
	options.dataUrl = urlObj.href;
	$.mobile.changePage( $page, options );
}

function Page_Home(obj) {
	//alert("Home Page");
	// Get the home Page, its header and content
	var $page = $('#home');
	// Get the header for the page.
	$header = $page.children( ":jqmData(role=header)" );
	
	// Get the content area element for the page.
	$content = $page.children( ":jqmData(role=content)" );
	
	$footer = $page.children( ":jqmData(role=footer)" );

	//Show logo
	$header.find('h1').html("<img src=\""+obj.Info.logo+"\" alt=\"Logo\" >");
	
	//Color Background
	//$('body').css('background-color',obj.Info.bkcolor);
	
	// Set organization name
	$('title').text(obj.Info.name);
	
	// Create the Categories menu
	
	// Unordered List
	
	var menuobj = '<ul data-role="listview" data-inset="true">';
	Object.keys(obj.Menu).forEach(function(category) {
		menuobj += '<li><a href="#menuitems?item='+category+'">'+category+'</a></li>';
	});
	menuobj += "</ul>";
	if ( restaurant_menu.Cart.Total > 0 ) {
		$footer.find("h4").html("Total = $"+Math.round(restaurant_menu.Cart.Total*100)/100);
	}
	$content.html(menuobj);
	$content.find( ":jqmData(role=listview)" ).listview();
}

// Listen for any attempts to call changePage.
// This is the circuit maker for all clicks
function PageBeforeChange( e, data ) {
	//alert("Page Before Change");
	// We only want to handle changePage() calls where the caller is
	// asking us to load a page by URL.
	//alert("PageBeforeChange");
	//alert(JSON.stringify(data)); // This is a great way to decipher an Object
	if ( typeof data.toPage === "string" ) {
		// We are being asked to load a page by URL, but we only
		// want to handle URLs that request the data for a specific
		// category.
		var u = $.mobile.path.parseUrl( data.toPage );
		//alert('Page = '+data.toPage);
		if ( u.hash.search(/^#menuitems/) !== -1 ) { // Get Menu Items
			// We're being asked to display the items for a specific category.
			// Call our internal method that builds the content for the category
			// on the fly based on our in-memory category data structure.
			Page_MenuItems( u, data.options );

			// Make sure to tell changePage() we've handled this call so it doesn't
			// have to do anything.
			e.preventDefault();
		}	
		else if (u.hash.search(/^#ops_addItem/) !== -1) { // ops_addItem
			//alert("Add Item Invokation"+data.toPage);
			ops_addItem(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#ops_removeItem/) !== -1) { // Remove Item
			ops_removeItem(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#cart/) !== -1) { // Cart Item
			Page_Cart(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#collectinfo/) !== -1) { // Cart Item
			Page_CollectInfo(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#sendneworder/) !== -1) { // TransmitOrder
			ops_sendNewOrder(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#postformmessage/) !== -1) { // TransmitOrder after processing the form
			ops_PostFormMessage(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#postmessage/) !== -1) { // TransmitOrder
			ops_postMessage(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#getmessage/) !== -1) { // Recieve Update
			ops_getMessage(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#order/) !== -1) { // Order Page
			Page_Order(u,data.options);
			e.preventDefault();
		}
		else if (u.hash.search(/^#back/) !== -1) { // Go Back
			history.back(-1);
		}
	}
	else {
		Page_Home(restaurant_menu);
	}
}

$(document).bind("mobileinit", function() {
	$.mobile.page.prototype.options.addBackBtn = true;
	$.mobile.selectmenu.prototype.options.nativeMenu = false;
	$.mobile.changePage.defaults.allowSamePageTransition = true;
});

$(document).ready(function() {
	//alert("Ready");
	$(document).bind( "pagebeforechange", function( e, data ) {
		PageBeforeChange(e,data);
	});
	Page_Home(restaurant_menu);

});